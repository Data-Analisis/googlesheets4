---
title: "Write Sheets"
---

```{r setup, include = FALSE}
can_decrypt <- gargle:::secret_can_decrypt("googlesheets4")
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = TRUE,
  purl = can_decrypt,
  eval = can_decrypt
)
```

```{r eval = !can_decrypt, echo = FALSE, comment = NA}
message("No token available. Code chunks will not be evaluated.")
```

## Attach googlesheets4

```{r}
library(googlesheets4)
```

## Auth

As a regular, interactive user, you can just let googlesheets4 prompt you for anything it needs re: auth.

Since this article is compiled noninteractively on a server, we have arranged for googlesheets4 to use a service account token (not shown).

```{r include = FALSE}
# happens in .onLoad() when IN_PKGDOWN, but need this for local dev/preview
googlesheets4:::sheets_auth_docs(drive = TRUE)  
```

## `sheets_create()`

Create a brand new Sheet with `sheets_create()`. You can specify the new Sheet's `name` (or accept a randomly generated name).

```{r}
sheets_create("write-sheets-demo-1")
```

Every Sheet *must* have at least one (work)sheet, so Google Sheets automatically creates an empty "Sheet1".

You can control the names and content of the initial (work)sheets with the `sheets` argument.

### Send sheet names

Use a character vector to specify the names of one or more empty sheets.

```{r}
sheets_create(
  "write-sheets-demo-2",
  sheets = c("alpha", "beta")
)
```

These sheets have no values and get their dimensions from Sheets default behaviour.

### Send a data frame

If you provide a data frame, it is used to populate the cells of a sheet and to set sheet dimensions (number of rows and columns). The header row also gets special treatment. The sheet inherits the name of the data frame, where possible.

```{r}
my_data <- data.frame(x = 1:3, y = letters[1:3])

sheets_create(
  "write-sheets-demo-3",
  sheets = my_data
)
```

### Send multiple data frames

If you provide a list of data frames, each is used to populate the cells of one sheet and to set sheet dimensions (number of rows and columns). The header row also gets special treatment. The sheets inherit the names from the list, if it has names.

```{r}
my_data_frames <- list(iris = head(iris), chickwts = head(chickwts))

sheets_create(
  "write-sheets-demo-4",
  sheets = my_data_frames
)
```

### Write metadata

Most users won't need to do this, but `sheets_create()` can set additional Sheet-level metadata, such as locale or time zone. To really make use of this feature, you need to read up on the [`spreadsheets.create` endpoint](https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets/create).

Notice how the default empty Sheet here is named "Feuille 1", since we request a French locale.

```{r}
sheets_create(
  "write-sheets-demo-5",
  locale = "fr_FR",
  timeZone = "Europe/Paris"
)
```

#### Clean up

Trash all the Sheets created above. This actually requires googledrive, since it is not possible to trash or delete Sheets through the Sheets API. In our hidden auth process, described earlier, we put a shared token into force for both Sheets and Drive. You can read how to do that in your own work in the article [Using googlesheets4 with googledrive](https://googlesheets4.tidyverse.org/articles/articles/drive-and-sheets.html).

```{r}
sheets_find("write-sheets-demo") %>%
  googledrive::drive_trash()
```

## `write_sheet()`, a.k.a. `sheets_write()`

`write_sheet()` is aliased to `sheets_write()` and is meant to evoke `readr::write_csv()` or `writexl::write_xlsx()`. Whereas `sheets_create()` emphasizes the *target Sheet*, `sheets_write()` emphasizes the *data you want to write*.

The only required argument for `sheets_write()` is the data.

```{r}
df <- data.frame(x = 1:3, y = letters[1:3])

ss <- sheets_write(df)
```

This creates a new (work)sheet inside a new (spread)Sheet and returns its ID. You'll notice the new Sheet has a randomly generated name. If that is a problem, use `sheets_create()` instead, which affords more control over various aspects of the new Sheet.

Let's start over: we delete that Sheet and call `sheets_create()`, so we can specify the new Sheet's name. Then we'll modify it with `sheets_write()`. We send one sheet name, "chickwts", to prevent the creation of "Sheet1", but we send no data.

```{r}
drive_rm(ss)

ss <- sheets_create(
  "write-sheets-demo-6",
  sheets = "chickwts"
)
```

`sheets_write()` allows us to write the actual `chickwts` data into the sheet by that name. 
```{r}
sheets_write(chickwts, ss = ss, sheet = "chickwts")
```

`sheets_write()` can also write data into a new sheet, if `sheet` implicitly or explicitly targets a non-existent sheet.

```{r}
# explicitly make a new sheet named "iris"
sheets_write(iris, ss = ss, sheet = "iris")

# implicitly make a new sheet named "mtcars"
sheets_write(mtcars, ss = ss)
```

If no sheet name is given and it can't be determined from `data`, a name of the form "SheetN" is automatically generated by Sheets.

```{r}
sheets_write(data.frame(x = 1:2, y = 3:4), ss)
```

`sheets_append()` can add one or more rows of data to an existing Sheet.

```{r}
sheets_append(data.frame(x = 3, y = 5), ss, sheet = "Sheet1")
```

#### Clean up

```{r}
sheets_find("write-sheets-demo") %>%
  googledrive::drive_trash()
```
